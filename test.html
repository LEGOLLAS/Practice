
#include <ESP8266WiFi.h>
#include <WiFiClient.h>
#include <ESP8266WebServer.h>
#include <WebSocketsServer.h>
#include <Hash.h>
#include <ArduinoJson.h>

//SOFT AP 방식
//연결할 ip주소의 데이터를 설정해준다.
const char* ip_name = "iptime-416";
const char* ip_pwd = "36500000";

//채팅할 웹페이지 설정
String WebPage = "<!DOCTYPE html>
<html>
  <meta charset=\"utf-8\">
  //채팅위해 필요한 텍스트 입력란 스타일 적용
  <style>
    input[type=\"text\"]{width: 90%; height: 3vh;}
    input[type=\"button\"]{width: 9%; height: 3.6vh;}
    .Chat{height: 90vh;}
    #ChatConsole{width: 80%; height: 100%; resize: none; margin:0 auto; }
  </style>
  <body onload=\"javascript:start();\">
    <div>
      //채팅위해 필요한 텍스트 입력란 생성
      <input class=\"text1\" type=\"text\" id=\"textBt\" onkeydown=\"if(event.keyCode==13) enterpressed();\">
      <input class=\"text1\" type=\"button\" onclick=\"enterpressed();\" value=\"Send\" >
    </div>
    <br>
    <div class=\"Chat\">
     <div id=\"ChatConsole\"><p>chat anything</p></div>
    </div>
    <script>
      var Socket;
      var chatArea = document.getElementById(\"ChatConsole\");
        function start(){
          //웹 소켓 인스턴스를 생성
          Socket = new WebSocket('ws://' + window.location.hostname + ':81/');
         	Socket.onmessage=function(evt){
            //소켓에 메시지를 출력할 떄 나타낼 형식
            var date = new Date();
            var dateTime = date.getFullYear() + \"-\" + date.getMonth() + \"-\" + date.getDate() + \" \" + date.getHours() + \":\" + date.getMinutes();
            //이벤트 데이터타입이 문자열일 경우 메시지에 dateTime 변수값을 나타내어라.
            if(typeofevent.data === \"string\"){
              console.log(\"123\" + chatArea.innerHTML);
              chatArea.innerHTML = chatArea.innerHTML + \"<p>\" + \"[\"+dateTime+\"]\" + event.data + \"</p>\";
              chatArea.scrollTop = chatArea.scrollHeight;
              }
            }
          }
        function enterpressed(){
          Socket.send(document.getElementById(\"textBt\").value);
          document.getElementById(\"textBt\").value=\"\";
          var arr = document.querySelectorAll(\'p\');
          //Jsonarray, textarray를 생성
          jsonarray = new Object();
          textarray = new Array();
          for (var i = 1; i < arr.length; i++) {
            textarray[i-1] = arr[i].innerText;
          }
          jsonarray[\'text\'] = textarray;console.log(jsonarray);
        }
    </script>
  </body>
</html>";

//웹소켓 포트81번으로 정의
WebSocketsServer webSocket = WebSocketsServer(81);
ESP8266WebServer server(80);

//LOCAL AP 방식
void setup() {
  Serial.begin(115200);
  WiFi.begin(ip_name, ip_pwd);
  Serial.println("");

  //시리얼 모니터에 연결된 서버정보를 출력할 때 나타날 메시지 설정
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
   }
    Serial.println("");
    Serial.print("Connected to ");
    Serial.println(ip_name);
    Serial.print("IP address: ");
    Serial.println(WiFi.localIP());

    server.on("/", [](){
    server.send(200, "text/html", WebPage);
    });

    server.begin();
    webSocket.begin();
    webSocket.onEvent(webSocketEvent);
}
void loop() {
    webSocket.loop();
    server.handleClient();
    if (Serial.available() > 0){
      char c[] = {(char)Serial.read()};
    }
}
void webSocketEvent(uint8_t num, WStype_t type, uint8_t * payload, size_t length){
   if (type == WStype_TEXT){
    String allc = "";
    for(int i = 0; i < length; i++){
      Serial.print((char) payload[i]);
      char c[] = {(char) payload[i]};
      allc = allc+c[i];
    }
    // 웹페이지에 출력
    webSocket.broadcastTXT(allc);
    Serial.println();
   }
}
